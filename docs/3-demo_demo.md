# Demo Demo

[_Documentation generated by Documatic_](https://www.documatic.com)

<!---Documatic-section-Codebase Structure-start--->
## Codebase Structure

<!---Documatic-block-system_architecture-start--->
```mermaid
None
```
<!---Documatic-block-system_architecture-end--->

# #
<!---Documatic-section-Codebase Structure-end--->

<!---Documatic-section-demo.demo.do_test-start--->
## [demo.demo.do_test](3-demo_demo.md#demo.demo.do_test)

<!---Documatic-section-do_test-start--->
<!---Documatic-block-demo.demo.do_test-start--->
<details>
	<summary><code>demo.demo.do_test</code> code snippet</summary>

```python
def do_test(args, cfg, model):
    list_of_ims = util.list_files(os.path.join(args.input_folder, ''), '*')
    model.eval()
    thres = args.threshold
    output_dir = cfg.OUTPUT_DIR
    min_size = cfg.INPUT.MIN_SIZE_TEST
    max_size = cfg.INPUT.MAX_SIZE_TEST
    augmentations = T.AugmentationList([T.ResizeShortestEdge(min_size, max_size, 'choice')])
    util.mkdir_if_missing(output_dir)
    category_path = os.path.join(util.file_parts(args.config_file)[0], 'category_meta.json')
    if category_path.startswith(util.CubeRCNNHandler.PREFIX):
        category_path = util.CubeRCNNHandler._get_local_path(util.CubeRCNNHandler, category_path)
    metadata = util.load_json(category_path)
    cats = metadata['thing_classes']
    for path in list_of_ims:
        im_name = util.file_parts(path)[1]
        im = util.imread(path)
        if im is None:
            continue
        image_shape = im.shape[:2]
        (h, w) = image_shape
        f_ndc = 4
        f = f_ndc * h / 2
        K = np.array([[f, 0.0, w / 2], [0.0, f, h / 2], [0.0, 0.0, 1.0]])
        aug_input = T.AugInput(im)
        _ = augmentations(aug_input)
        image = aug_input.image
        batched = [{'image': torch.as_tensor(np.ascontiguousarray(image.transpose(2, 0, 1))).cuda(), 'height': image_shape[0], 'width': image_shape[1], 'K': K}]
        dets = model(batched)[0]['instances']
        n_det = len(dets)
        meshes = []
        meshes_text = []
        if n_det > 0:
            for (idx, (corners3D, center_cam, center_2D, dimensions, pose, score, cat_idx)) in enumerate(zip(dets.pred_bbox3D, dets.pred_center_cam, dets.pred_center_2D, dets.pred_dimensions, dets.pred_pose, dets.scores, dets.pred_classes)):
                if score < thres:
                    continue
                cat = cats[cat_idx]
                bbox3D = center_cam.tolist() + dimensions.tolist()
                meshes_text.append('{} {:.2f}'.format(cat, score))
                color = [c / 255.0 for c in util.get_color(idx)]
                box_mesh = util.mesh_cuboid(bbox3D, pose.tolist(), color=color)
                meshes.append(box_mesh)
        print('File: {} with {} dets'.format(im_name, len(meshes)))
        if len(meshes) > 0:
            (im_drawn_rgb, im_topdown, _) = vis.draw_scene_view(im, K, meshes, text=meshes_text, scale=im.shape[0], blend_weight=0.5, blend_weight_overlay=0.85)
            if args.display:
                im_concat = np.concatenate((im_drawn_rgb, im_topdown), axis=1)
                vis.imshow(im_concat)
            util.imwrite(im_drawn_rgb, os.path.join(output_dir, im_name + '_boxes.jpg'))
            util.imwrite(im_topdown, os.path.join(output_dir, im_name + '_novel.jpg'))
        else:
            util.imwrite(im, os.path.join(output_dir, im_name + '_boxes.jpg'))
```
</details>
<!---Documatic-block-demo.demo.do_test-end--->
<!---Documatic-section-do_test-end--->

# #
<!---Documatic-section-demo.demo.do_test-end--->

<!---Documatic-section-demo.demo.setup-start--->
## [demo.demo.setup](3-demo_demo.md#demo.demo.setup)

<!---Documatic-section-setup-start--->
<!---Documatic-block-demo.demo.setup-start--->
<details>
	<summary><code>demo.demo.setup</code> code snippet</summary>

```python
def setup(args):
    cfg = get_cfg()
    get_cfg_defaults(cfg)
    config_file = args.config_file
    if config_file.startswith(util.CubeRCNNHandler.PREFIX):
        config_file = util.CubeRCNNHandler._get_local_path(util.CubeRCNNHandler, config_file)
    cfg.merge_from_file(config_file)
    cfg.merge_from_list(args.opts)
    cfg.freeze()
    default_setup(cfg, args)
    return cfg
```
</details>
<!---Documatic-block-demo.demo.setup-end--->
<!---Documatic-section-setup-end--->

# #
<!---Documatic-section-demo.demo.setup-end--->

<!---Documatic-section-demo.demo.main-start--->
## [demo.demo.main](3-demo_demo.md#demo.demo.main)

<!---Documatic-section-main-start--->
<!---Documatic-block-demo.demo.main-start--->
<details>
	<summary><code>demo.demo.main</code> code snippet</summary>

```python
def main(args):
    cfg = setup(args)
    model = build_model(cfg)
    logger.info('Model:\n{}'.format(model))
    DetectionCheckpointer(model, save_dir=cfg.OUTPUT_DIR).resume_or_load(cfg.MODEL.WEIGHTS, resume=True)
    with torch.no_grad():
        do_test(args, cfg, model)
```
</details>
<!---Documatic-block-demo.demo.main-end--->
<!---Documatic-section-main-end--->

# #
<!---Documatic-section-demo.demo.main-end--->

[_Documentation generated by Documatic_](https://www.documatic.com)